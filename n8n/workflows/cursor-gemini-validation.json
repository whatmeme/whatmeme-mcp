{
  "name": "Cursor Auto 모드 Gemini 검증",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "cursor-validation",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "GitHub Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "cursor-validation"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"검증 요청을 받았습니다\"\n}",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Webhook 응답",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [450, 100]
    },
    {
      "parameters": {
        "jsCode": "// GitHub Webhook payload에서 변경 정보 추출\nconst payload = $input.item.json;\n\n// Webhook 이벤트 타입 확인\nconst eventType = $env.GITHUB_EVENT_TYPE || payload.headers?.['x-github-event'] || 'push';\n\n// Push 이벤트인 경우만 처리\nif (eventType !== 'push' && eventType !== 'pull_request') {\n  return [{ json: { skip: true, reason: 'Unsupported event type' } }];\n}\n\n// 리포지토리 정보 추출\nconst repository = payload.repository || payload.pull_request?.head?.repo;\nconst ref = payload.ref || payload.pull_request?.head?.ref;\nconst after = payload.after || payload.pull_request?.head?.sha;\nconst before = payload.before || payload.pull_request?.base?.sha;\n\nif (!repository || !after) {\n  return [{ json: { error: 'Missing repository or commit information' } }];\n}\n\nreturn [{\n  json: {\n    eventType,\n    repository: {\n      owner: repository.owner.login,\n      name: repository.name,\n      fullName: repository.full_name\n    },\n    ref,\n    commit: after,\n    before,\n    commitUrl: `https://api.github.com/repos/${repository.full_name}/commits/${after}`,\n    compareUrl: `https://api.github.com/repos/${repository.full_name}/compare/${before}...${after}`\n  }\n}];"
      },
      "id": "extract-webhook-data",
      "name": "Webhook 데이터 추출",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "skip-check",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEqual"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-skip",
      "name": "건너뛰기 확인",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.compareUrl }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.GITHUB_TOKEN }}"
            },
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {}
      },
      "id": "get-changed-files",
      "name": "변경된 파일 목록 조회",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// 변경된 파일 중 TypeScript/JavaScript 파일만 필터링\nconst diffData = $input.item.json;\nconst files = diffData.files || [];\n\n// TypeScript/JavaScript 파일만 필터링\nconst codeFiles = files.filter(file => {\n  const filename = file.filename || '';\n  return filename.endsWith('.ts') || \n         filename.endsWith('.tsx') || \n         filename.endsWith('.js') || \n         filename.endsWith('.jsx');\n});\n\n// 변경 라인 수가 너무 많은 파일 제외 (1000줄 이상)\nconst filteredFiles = codeFiles.filter(file => {\n  const additions = file.additions || 0;\n  const deletions = file.deletions || 0;\n  return (additions + deletions) < 1000;\n});\n\nif (filteredFiles.length === 0) {\n  return [{ json: { skip: true, reason: 'No code files to validate' } }];\n}\n\nreturn filteredFiles.map(file => ({\n  json: {\n    filename: file.filename,\n    status: file.status,\n    additions: file.additions,\n    deletions: file.deletions,\n    changes: file.changes,\n    patch: file.patch || '',\n    blobUrl: file.blob_url,\n    rawUrl: file.contents_url\n  }\n}));"
      },
      "id": "filter-code-files",
      "name": "코드 파일 필터링",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-files",
      "name": "파일별 순회",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $('get-changed-files').item.json.repository.fullName }}/contents/{{ $json.filename }}?ref={{ $('get-changed-files').item.json.commit }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.GITHUB_TOKEN }}"
            },
            {
              "name": "Accept",
              "value": "application/vnd.github.v3.raw"
            }
          ]
        },
        "options": {}
      },
      "id": "get-file-content",
      "name": "파일 내용 조회",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 300],
      "notes": "이 노드는 실제 파일 내용을 가져옵니다. 필요시 제거하고 patch만 사용할 수 있습니다."
    },
    {
      "parameters": {
        "jsCode": "// Gemini Flash 3 검증 프롬프트 생성\nconst file = $input.item.json;\nconst repository = $('get-changed-files').item.json.repository;\nconst commit = $('get-changed-files').item.json.commit;\n\nconst patch = file.patch || '';\nconst filename = file.filename || '';\n\n// 프롬프트 구성\nconst validationPrompt = `당신은 TypeScript/Node.js 코드 리뷰어입니다.\n\n다음 코드 변경사항을 검증해주세요:\n\n**파일**: ${filename}\n**커밋**: ${commit}\n**변경 통계**: +${file.additions || 0}줄 / -${file.deletions || 0}줄\n\n**Diff**:\n\\`\\`\\`\n${patch.substring(0, 8000)}\n\\`\\`\\`\n\n**프로젝트 컨텍스트**:\n- MCP 서버 (Model Context Protocol)\n- Express 기반 HTTP 서버\n- TypeScript, Node.js, ESM 모듈\n- 밈 트렌드 분석 및 추천 서비스\n\n**검증 항목**:\n1. 타입 안정성: TypeScript 타입 오류 없음\n2. 로직 정확성: 비즈니스 로직이 올바름\n3. API 일관성: 기존 API 스펙과 일관성\n4. 에러 핸들링: 적절한 에러 처리\n5. 보안: 보안 취약점 없음\n6. 성능: 성능 저하 없음\n7. 코드 스타일: 기존 코드 스타일과 일관성\n\n**응답 형식** (JSON만 반환):\n{\n  \"valid\": boolean,\n  \"score\": number (0-100),\n  \"issues\": [\n    {\n      \"severity\": \"error\" | \"warning\" | \"info\",\n      \"message\": string,\n      \"line\": number (선택),\n      \"suggestion\": string (선택)\n    }\n  ],\n  \"summary\": string\n}`;\n\nreturn [{\n  json: {\n    filename,\n    patch,\n    prompt: validationPrompt,\n    repository,\n    commit\n  }\n}];"
      },
      "id": "build-validation-prompt",
      "name": "검증 프롬프트 생성",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={{ $env.GEMINI_API_KEY }}",
        "authentication": "none",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [\n    {\n      \"parts\": [\n        {\n          \"text\": \"{{ $json.prompt }}\"\n        }\n      ]\n    }\n  ],\n  \"generationConfig\": {\n    \"temperature\": 0.3,\n    \"topK\": 40,\n    \"topP\": 0.95,\n    \"maxOutputTokens\": 2048\n  }\n}",
        "options": {}
      },
      "id": "call-gemini-api",
      "name": "Gemini Flash 3 API 호출",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Gemini 응답 파싱 및 검증 결과 추출\nconst geminiResponse = $input.item.json;\nconst file = $('build-validation-prompt').item.json;\n\nlet validationResult;\n\ntry {\n  // Gemini 응답에서 텍스트 추출\n  const text = geminiResponse.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  \n  // JSON 추출 (마크다운 코드 블록 제거)\n  let jsonText = text.trim();\n  \n  // ```json ... ``` 형태 제거\n  if (jsonText.includes('```')) {\n    const match = jsonText.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n    if (match) {\n      jsonText = match[1].trim();\n    }\n  }\n  \n  // JSON 파싱\n  validationResult = JSON.parse(jsonText);\n} catch (error) {\n  // 파싱 실패 시 기본값\n  validationResult = {\n    valid: false,\n    score: 0,\n    issues: [{\n      severity: 'error',\n      message: 'Gemini 응답 파싱 실패: ' + error.message\n    }],\n    summary: '검증 결과를 파싱할 수 없습니다.'\n  };\n}\n\nreturn [{\n  json: {\n    filename: file.filename,\n    commit: file.commit,\n    repository: file.repository,\n    valid: validationResult.valid || false,\n    score: validationResult.score || 0,\n    issues: validationResult.issues || [],\n    summary: validationResult.summary || '검증 완료',\n    rawResponse: geminiResponse\n  }\n}];"
      },
      "id": "parse-validation-result",
      "name": "검증 결과 파싱",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "valid-check",
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-validation-result",
      "name": "검증 결과 확인",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2250, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.github.com/repos/{{ $json.repository.fullName }}/statuses/{{ $json.commit }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"state\": \"success\",\n  \"target_url\": \"{{ $env.N8N_BASE_URL }}/workflow/cursor-gemini-validation\",\n  \"description\": \"✅ Gemini 검증 통과 (점수: {{ $json.score }}/100)\",\n  \"context\": \"gemini-validation/{{ $json.filename }}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.GITHUB_TOKEN }}"
            },
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {}
      },
      "id": "update-github-status-success",
      "name": "GitHub 상태 업데이트 (성공)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2450, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.github.com/repos/{{ $json.repository.fullName }}/statuses/{{ $json.commit }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"state\": \"failure\",\n  \"target_url\": \"{{ $env.N8N_BASE_URL }}/workflow/cursor-gemini-validation\",\n  \"description\": \"❌ Gemini 검증 실패 (점수: {{ $json.score }}/100): {{ $json.summary.substring(0, 100) }}\",\n  \"context\": \"gemini-validation/{{ $json.filename }}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.GITHUB_TOKEN }}"
            },
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {}
      },
      "id": "update-github-status-failure",
      "name": "GitHub 상태 업데이트 (실패)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2450, 400]
    }
  ],
  "connections": {
    "GitHub Webhook": {
      "main": [
        [
          {
            "node": "Webhook 응답",
            "type": "main",
            "index": 0
          },
          {
            "node": "Webhook 데이터 추출",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook 데이터 추출": {
      "main": [[{ "node": "건너뛰기 확인", "type": "main", "index": 0 }]]
    },
    "건너뛰기 확인": {
      "main": [
        [
          {
            "node": "변경된 파일 목록 조회",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "변경된 파일 목록 조회": {
      "main": [[{ "node": "코드 파일 필터링", "type": "main", "index": 0 }]]
    },
    "코드 파일 필터링": {
      "main": [[{ "node": "파일별 순회", "type": "main", "index": 0 }]]
    },
    "파일별 순회": {
      "main": [[{ "node": "파일 내용 조회", "type": "main", "index": 0 }]]
    },
    "파일 내용 조회": {
      "main": [[{ "node": "검증 프롬프트 생성", "type": "main", "index": 0 }]]
    },
    "검증 프롬프트 생성": {
      "main": [[{ "node": "Gemini Flash 3 API 호출", "type": "main", "index": 0 }]]
    },
    "Gemini Flash 3 API 호출": {
      "main": [[{ "node": "검증 결과 파싱", "type": "main", "index": 0 }]]
    },
    "검증 결과 파싱": {
      "main": [[{ "node": "검증 결과 확인", "type": "main", "index": 0 }]]
    },
    "검증 결과 확인": {
      "main": [
        [
          {
            "node": "GitHub 상태 업데이트 (성공)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GitHub 상태 업데이트 (실패)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-15T00:00:00.000Z",
  "versionId": "1"
}
